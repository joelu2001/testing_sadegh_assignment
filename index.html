<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Traverse Assignment</title>
<style>
  body {margin:0;font-family:system-ui,Arial,sans-serif;background-color:#121212;color:#e0e0e0;}
  .wrap {display:flex;height:100vh;}
  .left {width:50%;padding:12px;border-right:1px solid #333;box-sizing:border-box;overflow:auto;background-color:#1e1e1e;}
  .right {width:50%;padding:12px;box-sizing:border-box;overflow:auto;background-color:#1e1e1e;}

  table {width:100%;}
  th,td {padding:6px;}
  input {width:100%;box-sizing:border-box;background-color:#2a2a2a;color:#e0e0e0;border:1px solid #444;}
  button {padding:8px 12px;background-color:#333;color:#e0e0e0;border:1px solid #555;cursor:pointer;}
  button:hover {background-color:#444;}
  .row {display:flex;gap:8px;margin:8px 0;flex-wrap:wrap;align-items:center;}
  #status {font-size:0.9rem;opacity:0.9;}
  #plot {border:1px solid #333;background-color:#181818;padding:8px;min-height:360px;display:grid;place-items:center;}
  #plot img {max-width:100%;height:auto;display:block;}
  .hint {font-size:0.9rem;opacity:0.9;}
  
  #dataTable{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;}
  #dataTable th,#dataTable td{
    padding:8px;
    vertical-align:middle;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    border:1px solid rgba(255,255,255,0.28);
  }

  #dataTable th{font-size:0.8rem;}
  #dataTable td{font-size:0.85rem;}
  #dataTable tbody tr{height:30px;}

  #dataTable input[type="number"]{
    width:100%;
    box-sizing:border-box;
    height:2.2em;
    line-height:2.2em;
    text-align:center;}
	
  #dataTable td:first-child{font-weight:500;white-space:nowrap;}
  #dataTable .bg-blue{background:rgba(59,130,246,0.18);background-clip:padding-box;}
  #dataTable .bg-green{background:rgba(34,197,94,0.18);background-clip:padding-box;}
  #dataTable td.bg-blue input,#dataTable td.bg-green input{background:transparent;}
</style>

</head>
<body>
  <div class="wrap">
    <div class="left">
      <h2>Inputs</h2>

      <div class="row">
        <button id="addRow">Add row</button>
        <button id="plotBtn" disabled>Plot</button>
        <span id="status">Loading Python…</span>
      </div>

      <p class="hint">
        Enter numeric x/y values. The plot will draw points and connect them in row order.
      </p>
		<table id="dataTable">
		  <thead>
			<tr>
			  <th rowspan="2">Punkt</th>
			  <th class="bg-green">Mätt vinkel (gon)</th>
			  <th>Fel i vinkel</th>
			  <th rowspan="2">Sidlängd (m)</th>
			  <th class="bg-green">ΔN</th>
			  <th class="bg-green">ΔE</th>
			  <th class="bg-green">Fel i N</th>
			</tr>
			<tr>
			  <th class="bg-blue">Bäring (gon)</th>
			  <th></th>
			  <th class="bg-blue">N</th>
			  <th class="bg-blue">E</th>
			  <th class="bg-blue">Fel i E</th>
			</tr>
		  </thead>
		  <tbody>
			<tr>
			  <td rowspan="2">20</td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			</tr>
			
			<tr>
			  <td></td>
			  <td></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="20"></td>
			  <td class="bg-blue"><input type="number" data-in="N" data-point="20"></td>
			  <td class="bg-blue"><input type="number" data-in="E" data-point="20"></td>
			  <td></td>
			</tr>
			
			<tr>
			  <td rowspan="2">21</td>
			  <td class="bg-blue"><input type="number" data-in="bearing" data-point="21"></td>
			  <td></td>
			  <td class="bg-green"><input class="out" data-out="dN" data-point="21" readonly></td>
			  <td class="bg-green"><input class="out" data-out="dE" data-point="21" readonly></td>
			  <td class="bg-green"><input class="out" data-out="wrong_in_N" data-point="21" readonly></td>
			</tr>
			
			<tr>
			  <td class="bg-green"><input type="number" data-in="measured_angle" data-point="21"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="21" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="21"></td>
			  <td class="bg-blue"><input class="out" data-out="N" data-point="21" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="E" data-point="21" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="wrong_in_E" data-point="21" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">22</td>
			  <td class="bg-blue"><input class="out" data-out="bearing" data-point="22" readonly></td>
			  <td></td>
			  <td class="bg-green"><input class="out" data-out="dN" data-point="22" readonly></td>
			  <td class="bg-green"><input class="out" data-out="dE" data-point="22" readonly></td>
			  <td class="bg-green"><input class="out" data-out="wrong_in_N" data-point="22" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green"><input type="number" data-in="measured_angle" data-point="22"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="22" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="22"></td>
			  <td class="bg-blue"><input class="out" data-out="N" data-point="22" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="E" data-point="22" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="wrong_in_E" data-point="22" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">23</td>
			  <td class="bg-blue"><input class="out" data-out="bearing" data-point="23" readonly></td>
			  <td></td>
			  <td class="bg-green"><input class="out" data-out="dN" data-point="23" readonly></td>
			  <td class="bg-green"><input class="out" data-out="dE" data-point="23" readonly></td>
			  <td class="bg-green"><input class="out" data-out="wrong_in_N" data-point="23" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green"><input type="number" data-in="measured_angle" data-point="23"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="23" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="23"></td>
			  <td class="bg-blue"><input class="out" data-out="N" data-point="23" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="E" data-point="23" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="wrong_in_E" data-point="23" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">24</td>
			  <td class="bg-blue"><input class="out" data-out="bearing" data-point="24" readonly></td>
			  <td></td>
			  <td class="bg-green"><input class="out" data-out="dN" data-point="24" readonly></td>
			  <td class="bg-green"><input class="out" data-out="dE" data-point="24" readonly></td>
			  <td class="bg-green"><input class="out" data-out="wrong_in_N" data-point="24" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green"><input type="number" data-in="measured_angle" data-point="24"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="24" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="24"></td>
			  <td class="bg-blue"><input class="out" data-out="N" data-point="24" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="E" data-point="24" readonly></td>
			  <td class="bg-blue"><input class="out" data-out="wrong_in_E" data-point="24" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">20</td>
			  <td class="bg-blue"><input class="out" data-out="bearing" data-point="20" readonly></td>
			  <td></td>
			  <td class="bg-green"><input class="out" data-out="dN" data-point="20" readonly></td>
			  <td class="bg-green"><input class="out" data-out="dE" data-point="20" readonly></td>
			  <td class="bg-green"><input class="out" data-out="wrong_in_N" data-point="20" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green"><input type="number" data-in="measured_angle" data-point="20"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="20" readonly></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td class="bg-blue"><input class="out" data-out="wrong_in_E" data-point="20" readonly></td>
			</tr>
			
		  </tbody>
		</table>
    </div>

    <div class="right">
      <h2>Plot</h2>
      <div id="plot"><div class="hint">Fill in the table in the left panel.</div></div>
    </div>
  </div>

  <!-- Pyodide (official CDN, pinned version) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

  <script>
    const tbody = document.querySelector("#dataTable tbody");
    const plotBtn = document.getElementById("plotBtn");
    const statusEl = document.getElementById("status");
    const plotEl = document.getElementById("plot");

    document.getElementById("addRow").addEventListener("click", () => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><input value="0"></td><td><input value="0"></td>`;
      tbody.appendChild(tr);
    });

    let pyodide = null;

    async function initPyodideAndPackages() {
      statusEl.textContent = "Loading Python runtime…";
      pyodide = await loadPyodide({
        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.29.0/full/"
      });

      statusEl.textContent = "Loading matplotlib + numpy…";
      await pyodide.loadPackage(["numpy", "matplotlib"]);

      // Define a Python helper that returns a base64 PNG string.
      pyodide.runPython(`
import base64
from io import BytesIO
import matplotlib
matplotlib.use("Agg")  # render offscreen to PNG
import math
import matplotlib.pyplot as plt

def plot_xy_to_base64(xs, ys):
    fig, ax = plt.subplots(figsize=(6.5, 4.0), dpi=150)
    ax.plot(xs, ys, marker="o", linestyle="-")
    ax.set_xlabel("x")
    ax.set_ylabel("y")
    ax.grid(True)

    buf = BytesIO()
    fig.tight_layout()
    fig.savefig(buf, format="png")
    plt.close(fig)
    buf.seek(0)
    return base64.b64encode(buf.read()).decode("utf-8")

POINTS = ["20", "21", "22", "23", "24"]

def gon_to_rad(g):
    return g * math.pi / 200.0

def _get(inputs, point, key):
    v = (inputs.get(point, {}) or {}).get(key, None)
    return float(v) if v is not None else None

def adjust_angles(beta_measured):
    f_beta = 400.0 - sum(beta_measured)
    d_beta = f_beta / 5.0
    beta_adj = [b + d_beta + 200.0 for b in beta_measured]
    return beta_adj, f_beta

def compute_bearings(phi_12, adjusted_angles):
    phi = [0.0] * 5
    phi[0] = phi_12
    for i in range(1, 5):
        phi[i] = (phi[i - 1] + adjusted_angles[i - 1] - 200.0) % 400.0
    return phi

def compute_increments(lengths, bearings):
    dN, dE = [], []
    for i in range(5):
        L = lengths[i]
        phi = gon_to_rad(bearings[i])
        dN.append(L * math.cos(phi))
        dE.append(L * math.sin(phi))
    return dN, dE

def compute_coordinate_errors(dN, dE):
    fN = -sum(dN)
    fE = -sum(dE)
    fR = math.sqrt(fN**2 + fE**2)
    return fN, fE, fR

def compute_Bowditch(fN, fE, lengths):
    total_length = sum(lengths)
    cor_N = [L * fN / total_length for L in lengths]
    cor_E = [L * fE / total_length for L in lengths]
    return cor_N, cor_E, total_length

def compute_coordinates(first_N, first_E, dN, dE, cor_N, cor_E):
    coordinates = []
    for i in range(5):
        N = first_N + sum(dN[:i]) + sum(cor_N[:i])
        E = first_E + sum(dE[:i]) + sum(cor_E[:i])
        coordinates.append((N, E))
    return coordinates

def compute(inputs):
    first_N = _get(inputs, "20", "N")
    first_E = _get(inputs, "20", "E")
    phi_12 = _get(inputs, "21", "bearing")

    ANGLE_POINTS = ["21", "22", "23", "24", "20"]

    beta_measured = [_get(inputs, p, "measured_angle") for p in ANGLE_POINTS]
    lengths = [_get(inputs, p, "side_length") for p in POINTS]

    if any(v is None for v in [first_N, first_E, phi_12] + beta_measured + lengths):
        return {}

    beta_adj, f_beta = adjust_angles(beta_measured)
    beta_adj_by_point = dict(zip(ANGLE_POINTS, beta_adj))

    bearings = compute_bearings(phi_12, beta_adj)
    dN, dE = compute_increments(lengths, bearings)
    fN, fE, fR = compute_coordinate_errors(dN, dE)
    cor_N, cor_E, total_L = compute_Bowditch(fN, fE, lengths)
    coords = compute_coordinates(first_N, first_E, dN, dE, cor_N, cor_E)

    bearing_incoming = {
        "21": bearings[0],
        "22": bearings[1],
        "23": bearings[2],
        "24": bearings[3],
        "20": bearings[4],
    }

    dN_incoming = {
        "21": dN[0],
        "22": dN[1],
        "23": dN[2],
        "24": dN[3],
        "20": dN[4],
    }

    dE_incoming = {
        "21": dE[0],
        "22": dE[1],
        "23": dE[2],
        "24": dE[3],
        "20": dE[4],
    }

    corN_incoming = {
        "21": cor_N[0],
        "22": cor_N[1],
        "23": cor_N[2],
        "24": cor_N[3],
        "20": cor_N[4],
    }

    corE_incoming = {
        "21": cor_E[0],
        "22": cor_E[1],
        "23": cor_E[2],
        "24": cor_E[3],
        "20": cor_E[4],
    }

    coord_by_point = {
        "20": (coords[0][0], coords[0][1]),
        "21": (coords[1][0], coords[1][1]),
        "22": (coords[2][0], coords[2][1]),
        "23": (coords[3][0], coords[3][1]),
        "24": (coords[4][0], coords[4][1]),
    }

    results = {}

    for p in POINTS:
        results[p] = {
            "dN": dN_incoming[p],
            "dE": dE_incoming[p],
            "bearing": bearing_incoming[p],
            "N": coord_by_point[p][0],
            "E": coord_by_point[p][1],
            "wrong_in_N": corN_incoming[p],
            "wrong_in_E": corE_incoming[p],
            "wrong_in_angle": beta_adj_by_point[p],
        }

    results["_global"] = {
        "f_beta": f_beta,
        "fN": fN,
        "fE": fE,
        "fR": fR,
        "total_length": total_L,
    }

    return results
`);

      statusEl.textContent = "Ready.";
      plotBtn.disabled = false;
    }

	async function doPlot() {
	  try {
		plotBtn.disabled = true;
		statusEl.textContent = "Plotting…";

		const inputs = collectInputs();

		pyodide.globals.set("inputs", pyodide.toPy(inputs));
		const results = pyodide.runPython("compute(inputs)").toJs();

		clearOutputs();
		fillOutputs(results);

		// ... keep your plotting code here if you already have it ...

		statusEl.textContent = "Done.";
	  } catch (err) {
		statusEl.textContent = "Error.";
		plotEl.innerHTML = `<div class="hint" style="color:#b00020;">${err.message}</div>`;
	  } finally {
		plotBtn.disabled = false;
	  }
	}
	
	function collectInputs() {
	  const inputs = {};
	  document.querySelectorAll('#dataTable input[data-in]').forEach(el => {
		const point = el.dataset.point;
		const key = el.dataset.in;

		const raw = el.value.trim();
		const val = raw === "" ? null : Number(raw);

		if (!inputs[point]) inputs[point] = {};
		inputs[point][key] = Number.isFinite(val) ? val : null;
	  });
	  return inputs;
	}

	function clearOutputs() {
	  document.querySelectorAll('#dataTable input.out[data-out]').forEach(el => {
		el.value = "";
	  });
	}

	function fillOutputs(results) {
	  document.querySelectorAll('#dataTable input.out[data-out]').forEach(el => {
		const point = el.dataset.point;
		const key = el.dataset.out;

		const pointObj = results?.[point];
		if (!pointObj) return;

		const v = pointObj[key];
		if (v === undefined || v === null) return;

		el.value = (typeof v === "number") ? v.toFixed(4) : String(v);
	  });
	}

    plotBtn.addEventListener("click", doPlot);

    // Kick off initialization
    initPyodideAndPackages().catch((err) => {
      statusEl.textContent = "Failed to load Python.";
      plotEl.innerHTML = `<div class="hint" style="color: #b00020;">${err.message}</div>`;
    });
  </script>
</body>
</html>

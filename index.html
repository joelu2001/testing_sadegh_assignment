<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Traverse Assignment</title>
  <style>
    body { margin: 0; font-family: system-ui, Arial, sans-serif; }
    .wrap { display: flex; height: 100vh; }
    .left { width: 50%; padding: 12px; border-right: 1px solid #ddd; box-sizing: border-box; overflow: auto; }
    .right { width: 50%; padding: 12px; box-sizing: border-box; overflow: auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    input { width: 100%; box-sizing: border-box; }
    .row { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; align-items: center; }
    button { padding: 8px 12px; }
    #status { font-size: 0.9rem; opacity: 0.85; }
    #plot { border: 1px solid #ddd; padding: 8px; min-height: 360px; display: grid; place-items: center; }
    #plot img { max-width: 100%; height: auto; display: block; }
    .hint { font-size: 0.9rem; opacity: 0.8; }
	
	body {background-color: #121212;color: #e0e0e0;}
	.left,
	.right {background-color: #1e1e1e;}
	.left {border-right: 1px solid #333;}
	table th, table td {border-color: #333;}
	input {background-color: #2a2a2a;color: #e0e0e0;border: 1px solid #444;}
	button {background-color: #333;color: #e0e0e0;border: 1px solid #555;cursor: pointer;}

	button:hover {background-color: #444;}
	#plot {background-color: #181818; border-color: #333;}
	.hint, #status {opacity: 0.9;}

	#dataTable td:first-child {font-weight: 500;white-space: nowrap;}
	#dataTable td:last-child {opacity: 0.8;text-align: center;}
	
	#dataTable{width:100%;table-layout:fixed;border-collapse:collapse;}
	#dataTable th,#dataTable td{padding:8px;vertical-align:middle;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border:1px solid #ccc;}
	#dataTable input[type="number"]{width:100%;box-sizing:border-box;height:2.2em;line-height:2.2em;text-align:center;}
	#dataTable tbody tr{height:30px;}
	#dataTable th{font-size:0.8rem;}
	#dataTable td{font-size:0.85rem;}
	
	#dataTable .bg-blue{background:rgba(59,130,246,0.18);}
	#dataTable .bg-green{background:rgba(34,197,94,0.18);} 
	#dataTable .bg-blue,#dataTable .bg-green{border-color:rgba(255,255,255,0.10);}
	#dataTable td.bg-blue input,#dataTable td.bg-green input{background:transparent;}
	#dataTable .bg-blue{background:rgba(59,130,246,0.18);background-clip:padding-box;}
	#dataTable .bg-green{background:rgba(34,197,94,0.18);background-clip:padding-box;}
	#dataTable th,#dataTable td{border:2px solid rgba(255,255,255,0.25);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <h2>Inputs</h2>

      <div class="row">
        <button id="addRow">Add row</button>
        <button id="plotBtn" disabled>Plot</button>
        <span id="status">Loading Python…</span>
      </div>

      <p class="hint">
        Enter numeric x/y values. The plot will draw points and connect them in row order.
      </p>
		<table id="dataTable">
		  <thead>
			<tr>
			  <th rowspan="2">Punkt</th>
			  <th class="bg-green">Mätt vinkel (gon)</th>
			  <th>Fel i vinkel</th>
			  <th rowspan="2">Sidlängd (m)</th>
			  <th>ΔN</th>
			  <th>ΔE</th>
			  <th>Fel i N</th>
			</tr>
			<tr>
			  <th class="bg-blue">Bäring (gon)</th>
			  <th></th>
			  <th>N</th>
			  <th>E</th>
			  <th>Fel i E</th>
			</tr>
		  </thead>
		  <tbody>
			<tr>
			  <td rowspan="2">20</td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			</tr>
			
			<tr>
			  <td></td>
			  <td></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="20"></td>
			  <td><input type="number" data-in="N" data-point="20"></td>
			  <td><input type="number" data-in="E" data-point="20"></td>
			  <td></td>
			</tr>
			
			<tr>
			  <td rowspan="2">21</td>
			  <td><input type="number" data-in="bearing" data-point="21"></td>
			  <td></td>
			  <td><input class="out" data-out="dN" data-point="21" readonly></td>
			  <td><input class="out" data-out="dE" data-point="21" readonly></td>
			  <td><input class="out" data-out="wrong_in_N" data-point="21" readonly></td>
			</tr>
			
			<tr>
			  <td><input type="number" data-in="measured_angle" data-point="21"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="21" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="21"></td>
			  <td><input class="out" data-out="N" data-point="21" readonly></td>
			  <td><input class="out" data-out="E" data-point="21" readonly></td>
			  <td><input class="out" data-out="wrong_in_E" data-point="21" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">22</td>
			  <td><input class="out" data-out="bearing" data-point="22" readonly></td>
			  <td></td>
			  <td><input class="out" data-out="dN" data-point="22" readonly></td>
			  <td><input class="out" data-out="dE" data-point="22" readonly></td>
			  <td><input class="out" data-out="wrong_in_N" data-point="22" readonly></td>
			</tr>

			<tr>
			  <td><input type="number" data-in="measured_angle" data-point="22"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="22" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="22"></td>
			  <td><input class="out" data-out="N" data-point="22" readonly></td>
			  <td><input class="out" data-out="E" data-point="22" readonly></td>
			  <td><input class="out" data-out="wrong_in_E" data-point="22" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">23</td>
			  <td><input class="out" data-out="bearing" data-point="23" readonly></td>
			  <td></td>
			  <td><input class="out" data-out="dN" data-point="23" readonly></td>
			  <td><input class="out" data-out="dE" data-point="23" readonly></td>
			  <td><input class="out" data-out="wrong_in_N" data-point="23" readonly></td>
			</tr>

			<tr>
			  <td><input type="number" data-in="measured_angle" data-point="23"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="23" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="23"></td>
			  <td><input class="out" data-out="N" data-point="23" readonly></td>
			  <td><input class="out" data-out="E" data-point="23" readonly></td>
			  <td><input class="out" data-out="wrong_in_E" data-point="23" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">24</td>
			  <td><input class="out" data-out="bearing" data-point="24" readonly></td>
			  <td></td>
			  <td><input class="out" data-out="dN" data-point="24" readonly></td>
			  <td><input class="out" data-out="dE" data-point="24" readonly></td>
			  <td><input class="out" data-out="wrong_in_N" data-point="24" readonly></td>
			</tr>

			<tr>
			  <td><input type="number" data-in="measured_angle" data-point="24"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="24" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="24"></td>
			  <td><input class="out" data-out="N" data-point="24" readonly></td>
			  <td><input class="out" data-out="E" data-point="24" readonly></td>
			  <td><input class="out" data-out="wrong_in_E" data-point="24" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">20</td>
			  <td><input class="out" data-out="bearing" data-point="20" readonly></td>
			  <td></td>
			  <td><input class="out" data-out="dN" data-point="20" readonly></td>
			  <td><input class="out" data-out="dE" data-point="20" readonly></td>
			  <td><input class="out" data-out="wrong_in_N" data-point="20" readonly></td>
			</tr>

			<tr>
			  <td><input type="number" data-in="measured_angle" data-point="20"></td>
			  <td><input class="out" data-out="wrong_in_angle" data-point="20" readonly></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td><input class="out" data-out="wrong_in_E" data-point="20" readonly></td>
			</tr>
			
			<tr>
			  <td><input class="out" data-out="bearing" data-point="20" readonly></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			</tr>
		  </tbody>
		</table>
    </div>

    <div class="right">
      <h2>Plot</h2>
      <div id="plot"><div class="hint">Fill in the table in the left panel.</div></div>
    </div>
  </div>

  <!-- Pyodide (official CDN, pinned version) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

  <script>
    const tbody = document.querySelector("#dataTable tbody");
    const plotBtn = document.getElementById("plotBtn");
    const statusEl = document.getElementById("status");
    const plotEl = document.getElementById("plot");

    document.getElementById("addRow").addEventListener("click", () => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><input value="0"></td><td><input value="0"></td>`;
      tbody.appendChild(tr);
    });

    function readTableXY() {
      const rows = [...tbody.querySelectorAll("tr")];
      const xs = [];
      const ys = [];

      for (const row of rows) {
        const inputs = row.querySelectorAll("input");
        const x = Number(inputs[0].value);
        const y = Number(inputs[1].value);

        if (!Number.isFinite(x) || !Number.isFinite(y)) {
          throw new Error("All table cells must be valid numbers.");
        }
        xs.push(x);
        ys.push(y);
      }
      if (xs.length < 1) throw new Error("Add at least one row.");
      return { xs, ys };
    }

    let pyodide = null;

    async function initPyodideAndPackages() {
      statusEl.textContent = "Loading Python runtime…";
      pyodide = await loadPyodide({
        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.29.0/full/"
      });

      statusEl.textContent = "Loading matplotlib + numpy…";
      await pyodide.loadPackage(["numpy", "matplotlib"]);

      // Define a Python helper that returns a base64 PNG string.
      pyodide.runPython(`
import base64
from io import BytesIO

import matplotlib
matplotlib.use("Agg")  # render offscreen to PNG

import matplotlib.pyplot as plt

def plot_xy_to_base64(xs, ys):
    fig, ax = plt.subplots(figsize=(6.5, 4.0), dpi=150)
    ax.plot(xs, ys, marker="o", linestyle="-")
    ax.set_xlabel("x")
    ax.set_ylabel("y")
    ax.grid(True)

    buf = BytesIO()
    fig.tight_layout()
    fig.savefig(buf, format="png")
    plt.close(fig)
    buf.seek(0)
    return base64.b64encode(buf.read()).decode("utf-8")
      `);

      statusEl.textContent = "Ready.";
      plotBtn.disabled = false;
    }

    async function doPlot() {
      try {
        plotBtn.disabled = true;
        statusEl.textContent = "Plotting…";

        const { xs, ys } = readTableXY();

        // Pass JS arrays to Python
        pyodide.globals.set("xs_js", pyodide.toPy(xs));
        pyodide.globals.set("ys_js", pyodide.toPy(ys));

        const b64 = pyodide.runPython(`plot_xy_to_base64(xs_js, ys_js)`);

        plotEl.innerHTML = `<img alt="matplotlib plot" src="data:image/png;base64,${b64}">`;
        statusEl.textContent = "Done.";
      } catch (err) {
        plotEl.innerHTML = `<div class="hint" style="color: #b00020;">${err.message}</div>`;
        statusEl.textContent = "Error.";
      } finally {
        plotBtn.disabled = false;
      }
    }

    plotBtn.addEventListener("click", doPlot);

    // Kick off initialization
    initPyodideAndPackages().catch((err) => {
      statusEl.textContent = "Failed to load Python.";
      plotEl.innerHTML = `<div class="hint" style="color: #b00020;">${err.message}</div>`;
    });
  </script>
</body>
</html>

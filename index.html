<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Traversprotokoll</title>
<style>
  body {margin:0;font-family:system-ui,Arial,sans-serif;background-color:#121212;color:#e0e0e0;}
  .wrap {display:flex;height:100vh;}
  .left {width:50%;padding:12px;border-right:1px solid #333;box-sizing:border-box;overflow:auto;background-color:#1e1e1e;}
  .right {width:50%;padding:12px;box-sizing:border-box;overflow:auto;background-color:#1e1e1e;}
  .author-note {text-align: center;font-size: 0.8rem;opacity: 0.6;margin-bottom: 6px;}
  #dataTable {zoom: 0.8;}

  table {width:100%;}
  th,td {padding:6px;}
  input {width:100%;box-sizing:border-box;background-color:#2a2a2a;color:#e0e0e0;border:1px solid #444;}
  button {padding:8px 12px;background-color:#333;color:#e0e0e0;border:1px solid #555;cursor:pointer;}
  button:hover {background-color:#444;}
  .row {display:flex;gap:8px;margin:8px 0;flex-wrap:wrap;align-items:center;}
  #status {font-size:0.9rem;opacity:0.9;}
  #plot {border:1px solid #333;background-color:#181818;padding:8px;min-height:360px;display:grid;place-items:center;}
  #plot img {max-width:100%;height:auto;display:block;}
  .hint {font-size:0.9rem;opacity:0.9;}
  
  #dataTable{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;}
  #dataTable th,#dataTable td{
    padding:8px;
    vertical-align:middle;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    border:1px solid rgba(255,255,255,0.28);
  }

  #dataTable th{font-size:0.8rem;}
  #dataTable td {font-size:0.85rem; height: 25px;}
  #dataTable tbody tr{height:25px;}

  #dataTable input{width:100%; box-sizing:border-box; height:2.2em; line-height:2.2em; text-align:center;}

  #dataTable td.no-top-border {border-top: none;}
  #dataTable td.no-bottom-border {border-bottom: none;}	

  #dataTable td:first-child{font-weight:500;white-space:nowrap;}
  #dataTable .bg-blue{background:rgba(59,130,246,0.18);background-clip:padding-box;}
  #dataTable .bg-green{background:rgba(34,197,94,0.18);background-clip:padding-box;}
  #dataTable td.bg-blue input,#dataTable td.bg-green input{background:transparent;}
  
  #dataTable input {text-align: center;}
  
  @keyframes flashRed {0% { background-color: rgba(239, 68, 68, 0.25); }100% { background-color: transparent; }}
  .flash-missing {animation: flashRed 350ms ease-out;}
</style>

</head>
<body>
  <div class="wrap">
    <div class="left">
	<div class="author-note">
		Utvecklat av Joel Utsi & Sadegh Jamali
	</div>
      <h2>Traversprotokoll</h2>

      <div class="row">
        <button id="plotBtn" disabled>Utför beräkning</button>
        <span id="status">Laddar Python…</span>
      </div>

      <p class="hint">
        Fyll i värden för observationer nedan, tryck därefter på "Utför beräkning".
      </p>
		<table id="dataTable">
		  <tbody>
			<tr>
			  <th rowspan="2">Punkt</th>
			  <th class="bg-green no-bottom-border">Mätt vinkel (gon)</th>
			  <th class="no-bottom-border"> Fel i vinkel</th>
			  <th rowspan="2">Sidlängd (m)</th>
			  <th class="bg-green">ΔN</th>
			  <th class="bg-green">ΔE</th>
			  <th class="bg-green">Fel i N</th>
			</tr>
			<tr>
			  <th class="bg-blue no-top-border">Bäring (gon)</th>
			  <th class="no-top-border"></th>
			  <th class="bg-blue">N</th>
			  <th class="bg-blue">E</th>
			  <th class="bg-blue">Fel i E</th>
			</tr>
			<tr>
			  <td rowspan="2">20</td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			  <td></td>
			</tr>
			
			<tr>
			  <td class="no-bottom-border"></td>
			  <td class="no-bottom-border"></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="20"></td>
			  <td class="bg-blue"><input type="number" data-in="N" data-point="20"></td>
			  <td class="bg-blue"><input type="number" data-in="E" data-point="20"></td>
			  <td></td>
			</tr>
			
			<tr>
			  <td rowspan="2">21</td>
			  <td class="bg-blue no-top-border"><input type="number" data-in="bearing" data-point="21"></td>
			  <td class="no-top-border"></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dN" data-point="21" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dE" data-point="21" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="wrong_in_N" data-point="21" data-decimals="4" readonly></td>
			</tr>
			
			<tr>
			  <td class="bg-green no-bottom-border"><input type="number" data-in="measured_angle" data-point="21"></td>
			  <td><input class="out no-bottom-border" data-out="wrong_in_angle" data-point="21" data-decimals="4" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="21"></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="N" data-point="21" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="E" data-point="21" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="wrong_in_E" data-point="21" data-decimals="4" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">22</td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="bearing" data-point="22" data-decimals="4" readonly></td>
			  <td class="no-top-border"></tdclass></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dN" data-point="22" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dE" data-point="22" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="wrong_in_N" data-point="22" data-decimals="4" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green no-bottom-border"><input type="number" data-in="measured_angle" data-point="22"></td>
			  <td><input class="out no-bottom-border" data-out="wrong_in_angle" data-point="22" data-decimals="4" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="22"></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="N" data-point="22" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="E" data-point="22" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="wrong_in_E" data-point="22" data-decimals="4" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">23</td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="bearing" data-point="23" data-decimals="4" readonly></td>
			  <td class="no-top-border"></tdclass></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dN" data-point="23" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dE" data-point="23" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="wrong_in_N" data-point="23" data-decimals="4" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green no-bottom-border"><input type="number" data-in="measured_angle" data-point="23"></td>
			  <td><input class="out no-bottom-border" data-out="wrong_in_angle" data-point="23" data-decimals="4" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="23"></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="N" data-point="23" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="E" data-point="23" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="wrong_in_E" data-point="23" data-decimals="4" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">24</td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="bearing" data-point="24" data-decimals="4" readonly></td>
			  <td class="no-top-border"></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dN" data-point="24" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dE" data-point="24" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="wrong_in_N" data-point="24" data-decimals="4" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green no-bottom-border"><input type="number" data-in="measured_angle" data-point="24"></td>
			  <td><input class="out no-bottom-border" data-out="wrong_in_angle" data-point="24" data-decimals="4" readonly></td>
			  <td rowspan="2"><input type="number" data-in="side_length" data-point="24"></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="N" data-point="24" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="E" data-point="24" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="wrong_in_E" data-point="24" data-decimals="4" readonly></td>
			</tr>
			
			<tr>
			  <td rowspan="2">20</td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="bearing" data-point="20" data-decimals="4" readonly></td>
			  <td class="no-top-border"></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dN" data-point="20" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="dE" data-point="20" readonly></td>
			  <td class="bg-green no-bottom-border"><input class="out" data-out="wrong_in_N" data-point="20" data-decimals="4" readonly></td>
			</tr>

			<tr>
			  <td class="bg-green no-bottom-border"><input type="number" data-in="measured_angle" data-point="20"></td>
			  <td class="no-bottom-border"><input class="out" data-out="wrong_in_angle" data-point="20" data-decimals="4" readonly></td>
			  <td class="no-bottom-border"></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="repeated_20_N" data-point="20" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="repeated_20_E" data-point="20" readonly></td>
			  <td class="bg-blue no-top-border"><input class="out" data-out="wrong_in_E" data-point="20" data-decimals="4" readonly></td>
			</tr>

			<tr>
			  <td rowspan="3"></td>
			  <td class="no-top-border"><input class="out" data-out="last_bearing" data-format="parens" readonly></td>
			  <td class="no-top-border"></td>
			  <td class="no-top-border"></td>
			  <td><input class="out" data-out="last_E" data-format="parens" readonly></td>
			  <td><input class="out" data-out="last_N" data-format="parens" readonly></td>
			  <td></td>
			</tr>

			<tr>
			  <th class="no-bottom-border">f<sub>β</sub></th>
			  <th class="no-bottom-border"></th>
			  <th class="no-bottom-border">Σ</th>
			  <th class="no-bottom-border">f<sub>N</sub></th>
			  <th class="no-bottom-border">f<sub>E</sub></th>
			  <th class="no-bottom-border">f<sub>r</sub></th>
			</tr>

			  <tr>
				  <td><input class="out no-top-border" data-out="f_beta" readonly></td>
				  <td class="no-top-border"></td>
				  <td><input class="out no-top-border" data-out="total_length" readonly></td>
				  <td><input class="out no-top-border" data-out="fN" readonly></td>
				  <td><input class="out no-top-border" data-out="fE" readonly></td>
				  <td><input class="out no-top-border" data-out="fR" readonly></td>
				</tr>
		  </tbody>
		</table>
    </div>

    <div class="right">
      <h2>Stängd polygontåg</h2>
      <div id="plot"><div class="hint">Fyll i traversprotokollet till vänster.</div></div>
    </div>
  </div>

  <!-- Pyodide (official CDN, pinned version) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

  <script>
    const tbody = document.querySelector("#dataTable tbody");
    const plotBtn = document.getElementById("plotBtn");
    const statusEl = document.getElementById("status");
    const plotEl = document.getElementById("plot");

    let pyodide = null;

    async function initPyodideAndPackages() {
      statusEl.textContent = "Laddar Python...";
      pyodide = await loadPyodide({
        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.29.0/full/"
      });

      statusEl.textContent = "Laddar matplotlib + numpy...";
      await pyodide.loadPackage(["numpy", "matplotlib"]);

      // Define a Python helper that returns a base64 PNG string.
      pyodide.runPython(`
import base64
from io import BytesIO
import matplotlib
matplotlib.use("Agg")  # render offscreen to PNG
import math
import matplotlib.pyplot as plt

def plot_xy_to_base64(xs, ys):
    fig, ax = plt.subplots(figsize=(5, 5), dpi=400)

    ax.plot(xs, ys, marker="o", linestyle="-")

    labels = ["20", "21", "22", "23", "24"]
    n = min(5, len(xs), len(ys))

    for i in range(n):
        ax.annotate(
            labels[i],
            (xs[i], ys[i]),
            textcoords="offset points",
            xytext=(5, 5),
            ha="left",
            va="bottom",
            fontsize=9,
        )

    ax.set_xlabel("E")
    ax.set_ylabel("N")
    ax.set_aspect("equal", adjustable="box")

    min_x, max_x = min(xs), max(xs)
    min_y, max_y = min(ys), max(ys)

    span = max(max_x - min_x, max_y - min_y, 1.0)
    pad = 0.10 * span

    ax.set_xlim(min_x - pad, max_x + pad)
    ax.set_ylim(min_y - pad, max_y + pad)

    ax.grid(True, which="major")
    ax.minorticks_on()
    ax.grid(True, which="minor", alpha=0.3)

    buf = BytesIO()
    fig.tight_layout()
    fig.savefig(buf, format="png")
    plt.close(fig)

    buf.seek(0)
    return base64.b64encode(buf.read()).decode("utf-8")

POINTS = ["20", "21", "22", "23", "24"]

def gon_to_rad(g):
    return g * math.pi / 200.0

def _get(inputs, point, key):
    v = (inputs.get(point, {}) or {}).get(key, None)
    return float(v) if v is not None else None

def adjust_angles(angles):
    β = [a[3] for a in angles]
    fβ = 400 - sum(β)
    dβ = fβ / 5
    return [βi + dβ + 200 for βi in β]

def compute_bearings(phi_12, adjusted_angles):
    phi = [0.0] * 5
    phi[0] = phi_12
    for i in range(1, 5):
        phi[i] = (phi[i - 1] + adjusted_angles[i - 1] - 200.0) % 400.0
    return phi

def compute_increments(lengths, bearings):
    dN, dE = [], []
    for i in range(5):
        L = lengths[i]  # now a float
        phi = gon_to_rad(bearings[i])
        dN.append(L * math.cos(phi))
        dE.append(L * math.sin(phi))
    return dN, dE

def compute_coordinate_errors(dN, dE):
    fN = -sum(dN)
    fE = -sum(dE)
    fR = math.sqrt(fN**2 + fE**2)
    return fN, fE, fR

def compute_Bowditch(fN, fE, lengths):
    total_length = sum(lengths)
    cor_N = [L * fN / total_length for L in lengths]
    cor_E = [L * fE / total_length for L in lengths]
    return cor_N, cor_E, total_length

def compute_coordinates(first_N, first_E, dN, dE, cor_N, cor_E):
    coordinates = []
    for i in range(5):
        N = first_N + sum(dN[:i]) + sum(cor_N[:i])
        E = first_E + sum(dE[:i]) + sum(cor_E[:i])
        coordinates.append((N, E))
    return coordinates

def compute(inputs):
    first_N = _get(inputs, "20", "N")
    first_E = _get(inputs, "20", "E")
    phi_12 = _get(inputs, "21", "bearing")

    ANGLE_POINTS = ["21", "22", "23", "24", "20"]
    LEG_POINTS = ["20", "21", "22", "23", "24"]

    beta_measured = [_get(inputs, p, "measured_angle") for p in ANGLE_POINTS]
    leg_lengths = [_get(inputs, p, "side_length") for p in LEG_POINTS]

    if any(v is None for v in [first_N, first_E, phi_12] + beta_measured + leg_lengths):
        return {}

    angles = [[0.0, 0.0, 0.0, b] for b in beta_measured]
    lengths = leg_lengths

    adjusted_angles = adjust_angles(angles)

    wrong_in_angle_by_point = {
        p: adjusted_angles[i] - beta_measured[i]
        for i, p in enumerate(ANGLE_POINTS)
    }

    f_beta = 0
    for i in wrong_in_angle_by_point.values():
        f_beta += i

    bearings = compute_bearings(phi_12, adjusted_angles)
    dN, dE = compute_increments(lengths, bearings)

    fN, fE, fR = compute_coordinate_errors(dN, dE)
    cor_N, cor_E, total_L = compute_Bowditch(fN, fE, lengths)
    coords = compute_coordinates(first_N, first_E, dN, dE, cor_N, cor_E)

    bearing_incoming = {
        "21": bearings[0],
        "22": bearings[1],
        "23": bearings[2],
        "24": bearings[3],
        "20": bearings[4],
    }

    dN_incoming = {
        "21": dN[0],
        "22": dN[1],
        "23": dN[2],
        "24": dN[3],
        "20": dN[4],
    }

    dE_incoming = {
        "21": dE[0],
        "22": dE[1],
        "23": dE[2],
        "24": dE[3],
        "20": dE[4],
    }

    corN_incoming = {
        "21": cor_N[0],
        "22": cor_N[1],
        "23": cor_N[2],
        "24": cor_N[3],
        "20": cor_N[4],
    }

    corE_incoming = {
        "21": cor_E[0],
        "22": cor_E[1],
        "23": cor_E[2],
        "24": cor_E[3],
        "20": cor_E[4],
    }

    coord_by_point = {
        "20": (coords[0][0], coords[0][1]),
        "21": (coords[1][0], coords[1][1]),
        "22": (coords[2][0], coords[2][1]),
        "23": (coords[3][0], coords[3][1]),
        "24": (coords[4][0], coords[4][1]),
    }

    results = {}
    for p in POINTS:
        results[p] = {
            "bearing": bearing_incoming[p],
            "dN": dN_incoming[p],
            "dE": dE_incoming[p],
            "N": coord_by_point[p][0],
            "E": coord_by_point[p][1],
            "wrong_in_N": corN_incoming[p],
            "wrong_in_E": corE_incoming[p],
            "wrong_in_angle": wrong_in_angle_by_point[p],
			"repeated_20_N": first_N,
			"repeated_20_E": first_E
        }

    results["_global"] = {
        "f_beta": f_beta,
        "fN": fN,
        "fE": fE,
        "fR": fR,
        "total_length": total_L,
		"last_bearing": phi_12 - f_beta,
		"last_N": first_N - fN,
		"last_E": first_N - fE
    }

    return results
`);

      statusEl.textContent = "Redo.";
      plotBtn.disabled = false;
    }

	async function doPlot() {
	  try {
		plotBtn.disabled = true;
		
		if (!allObservationsFilled()) {
		  flashMissingInputs();
		  clearFlashClassAfter();

		  plotEl.innerHTML =
			`<div class="hint" style="color:#fca5a5;">
			  Fyll i alla tomma observationer först!
			</div>`;
		  statusEl.textContent = "Saknar data.";
		  return;
		}

		statusEl.textContent = "Beräknar + plottar...";

		const inputs = collectInputs();

		pyodide.globals.set("inputs", pyodide.toPy(inputs));
		const results = pyodide.runPython("compute(inputs)").toJs();

		clearOutputs();
		fillOutputs(results);

		const order = ["20", "21", "22", "23", "24", "20"]; 
		const xs = [];
		const ys = [];

		for (const p of order) {
		  const pt = results?.[p];
		  if (!pt || pt.E === undefined || pt.N === undefined || pt.E === null || pt.N === null) {
			throw new Error(`Saknar N/E för punkt ${p}.`);
		  }
		  xs.push(Number(pt.E)); 
		  ys.push(Number(pt.N)); 
		}

		pyodide.globals.set("xs_js", pyodide.toPy(xs));
		pyodide.globals.set("ys_js", pyodide.toPy(ys));
		const b64 = pyodide.runPython("plot_xy_to_base64(xs_js, ys_js)");

		plotEl.innerHTML = `<img alt="Traverse plot" src="data:image/png;base64,${b64}">`;

		statusEl.textContent = "Klar.";
	  } catch (err) {
		statusEl.textContent = "Fel.";
		plotEl.innerHTML = `<div class="hint" style="color:#b00020;">${err.message || err}</div>`;
	  } finally {
		plotBtn.disabled = false;
	  }
	}

	function collectInputs() {
	  const inputs = {};
	  document.querySelectorAll('#dataTable input[data-in]').forEach(el => {
		const point = el.dataset.point;
		const key = el.dataset.in;

		const raw = el.value.trim();
		const val = raw === "" ? null : Number(raw);

		if (!inputs[point]) inputs[point] = {};
		inputs[point][key] = Number.isFinite(val) ? val : null;
	  });
	  return inputs;
	}

	function clearOutputs() {
	  document.querySelectorAll('#dataTable input.out[data-out]').forEach(el => {
		el.value = "";
	  });
	}

	function fillOutputs(results) {
	  document.querySelectorAll('#dataTable input.out[data-out]').forEach(el => {
		const key = el.dataset.out;
		const point = el.dataset.point;

		let value = null;

		if (point) {
		  value = results?.[point]?.[key];
		} else {
		  value = results?._global?.[key];
		}

		if (value === undefined || value === null) return;

		let decimals = el.dataset.decimals ? parseInt(el.dataset.decimals) : 3;
		let displayValue = typeof value === "number" ? value.toFixed(decimals).replace('.', ',') : String(value);

		if (el.dataset.format === "parens") {
		displayValue = `(${displayValue})`;
		}

		el.value = displayValue;
	  });
	}

	function allObservationsFilled() {
	  const inputs = document.querySelectorAll('#dataTable input[data-in]');
	  for (const el of inputs) {
		if (el.value.trim() === "" || !Number.isFinite(Number(el.value))) {
		  return false;
		}
	  }
	  return true;
	}
	
	function flashMissingInputs() {
	  const inputs = document.querySelectorAll('#dataTable input[data-in]');
	  for (const el of inputs) {
		const v = el.value.trim();
		const ok = v !== "" && Number.isFinite(Number(v));

		if (!ok) {
		  // remove first so animation can retrigger on repeated clicks
		  el.classList.remove("flash-missing");
		  // force reflow
		  void el.offsetWidth;
		  el.classList.add("flash-missing");
		}
	  }
	}

	function clearFlashClassAfter() {
	  // clean up after animation ends (optional but tidy)
	  setTimeout(() => {
		document.querySelectorAll('#dataTable input.flash-missing')
		  .forEach(el => el.classList.remove('flash-missing'));
	  }, 450);
	}

    plotBtn.addEventListener("click", doPlot);

    // Kick off initialization
    initPyodideAndPackages().catch((err) => {
      statusEl.textContent = "Lyckades inte ladda Python.";
      plotEl.innerHTML = `<div class="hint" style="color: #b00020;">${err.message}</div>`;
    });
  </script>
</body>
</html>
